<script type="module">

/* =========================
   Stripe Success Logic بدون تسجيل دخول
========================= */

window.onload = async () => {

  try {

    // جلب session_id و productId من الرابط
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get("session_id");
    const productId = urlParams.get("productId");

    if (!sessionId || !productId) {
      alert("Missing payment information");
      return;
    }

    // إرسال إلى السيرفر بدون توكن Firebase
    const res = await fetch("https://api.creovia.uk/verify-stripe-payment", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        sessionId,
        productId
      })
    });

    const data = await res.json();

    if (data.success) {

      // تحميل الكتاب
      window.location.href = data.downloadUrl;

    } else {

      alert("Payment verification failed");

    }

  } catch (err) {
    console.error(err);
    alert("Error verifying payment");
  }

};

</script>
