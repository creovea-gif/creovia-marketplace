<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

const firebaseConfig = { /* ... */ };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const params = new URLSearchParams(window.location.search);
const sessionId = params.get("session_id");
const productId = params.get("productId");

if (!sessionId || !productId) {
  alert("Invalid payment session.");
  window.location.href = "index.html";
}

auth.onAuthStateChanged(async (user) => {
  if (!user) {
    alert("You must be logged in to verify payment.");
    window.location.href = "login.html";
    return;
  }

  try {
    const token = await user.getIdToken();

    const res = await fetch("https://api.creovia.uk/verify-stripe-payment", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ sessionId, productId })
    });

    const result = await res.json();

    if (res.ok && result.success) {
      alert("Payment successful");
      window.location.href = result.downloadUrl;
    } else {
      alert("Payment verification failed");
      console.error(result);
    }

  } catch (err) {
    console.error(err);
    alert("Could not verify payment. Try again later.");
  }
});
</script>
