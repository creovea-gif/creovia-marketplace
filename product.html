<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Product</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  collection,
  getDocs,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCh2Pf1c1Gb7fQCQy64WmNYvWBKffwiuOs",
  authDomain: "creoveo-7da32.firebaseapp.com",
  projectId: "creoveo-7da32"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.currentUser = null;
onAuthStateChanged(auth, user => {
  window.currentUser = user;
});
</script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    padding: 20px;
}
.card {
    max-width: 700px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 12px;
}
img {
    width: 100%;
    border-radius: 8px;
}
.buy-btn {
    margin-top: 15px;
    padding: 12px;
    width: 100%;
    border: none;
    background: #6366f1;
    color: white;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
}
.rating-box {
    margin-top: 25px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
}
.rating-box textarea {
    width: 100%;
    padding: 8px;
}
.rating-actions button {
    margin-right: 10px;
    padding: 8px 14px;
    cursor: pointer;
}
.stats {
    margin-top: 10px;
    font-weight: bold;
}
</style>
</head>
<body>

<div class="card">
    <h2 id="name"></h2>
    <p id="seller"></p>
    <img id="image">
    <p id="desc"></p>
    <h3 id="price"></h3>

    <div id="paypal-button-container"></div>

    <!-- â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
    <div class="rating-box">
        <h3>Ratings</h3>
        <div class="stats">
            ğŸ‘ <span id="likes">0</span> |
            ğŸ‘ <span id="dislikes">0</span>
        </div>

        <textarea id="comment" placeholder="Leave a comment (optional)"></textarea>

        <div class="rating-actions">
            <button id="likeBtn">ğŸ‘ Like</button>
            <button id="dislikeBtn">ğŸ‘ Dislike</button>
        </div>
    </div>
</div>

<script src="https://www.paypal.com/sdk/js?client-id=Ady-fs_MNNG5Ue22tNNapD9abvFULboMBDy5vAbpDYt8jCVNkqeyS1hssK58OTIWLWQt5xHxZlcZ_hSB&currency=USD&intent=capture"></script>

<script type="module">
import {
  getFirestore,
  collection,
  doc,
  getDocs,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const db = getFirestore();

const params = new URLSearchParams(window.location.search);
const productId = params.get('id');

let currentProduct = null;

// ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
fetch('https://backend-creovea.onrender.com/products')
.then(res => res.json())
.then(products => {
    currentProduct = products.find(p => p.id === productId);
    if (!currentProduct) return alert('Product not found');

    name.textContent = currentProduct.name;
    seller.textContent = 'Seller: ' + currentProduct.sellerEmail;
    desc.textContent = currentProduct.description;
    price.textContent = '$' + currentProduct.price;
    image.src = currentProduct.previewImage;

    loadRatings();

    paypal.Buttons({
        createOrder: (data, actions) => {
            return actions.order.create({
                purchase_units: [{ amount: { value: currentProduct.price } }]
            });
        },
        onApprove: async (data) => {
            const res = await fetch('https://backend-creovea.onrender.com/record-payment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    productId: currentProduct.id,
                    orderId: data.orderID
                })
            });
            const result = await res.json();
            if (result.success) {
                window.location.href = result.downloadUrl;
            }
        }
    }).render('#paypal-button-container');
});

// ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
async function loadRatings() {
    const snap = await getDocs(collection(db, 'products', productId, 'ratings'));
    let likes = 0, dislikes = 0;

    snap.forEach(doc => {
        doc.data().like ? likes++ : dislikes++;
    });

    document.getElementById('likes').textContent = likes;
    document.getElementById('dislikes').textContent = dislikes;
}

// ğŸ”¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
async function submitRating(isLike) {
    if (!window.currentUser) {
        alert('Login required');
        return;
    }

    try {
        await setDoc(
            doc(db, 'products', productId, 'ratings', window.currentUser.uid),
            {
                like: isLike,
                comment: document.getElementById('comment').value,
                createdAt: Date.now()
            }
        );
        alert('Thank you for rating');
        loadRatings();
    } catch {
        alert('You already rated this product');
    }
}

document.getElementById('likeBtn').onclick = () => submitRating(true);
document.getElementById('dislikeBtn').onclick = () => submitRating(false);
</script>

</body>
</html>
