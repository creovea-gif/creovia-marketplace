<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Product</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    padding: 20px;
}
.card {
    max-width: 700px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 12px;
}
img {
    width: 100%;
    border-radius: 8px;
}
button {
    padding: 8px 12px;
    margin-right: 5px;
    cursor: pointer;
}
</style>
</head>

<body>

<div class="card">
    <h2 id="name"></h2>
    <p id="seller"></p>
    <img id="image">
    <p id="desc"></p>
    <h3 id="price"></h3>

    <hr>

    <h3>Reviews</h3>
    <div id="reviewsList"></div>

    <div id="reviewForm">
        <p><strong>Your Review</strong></p>
        <button id="likeBtn">üëç Like</button>
        <button id="dislikeBtn">üëé Dislike</button>
        <br><br>
        <textarea id="reviewComment" placeholder="Write a comment..."
          style="width:100%; padding:8px;"></textarea>
        <br><br>
        <button id="submitReview">Submit Review</button>
    </div>

    <hr>

    <div id="paypal-button-container"></div>
</div>

<!-- PayPal -->
<script src="https://www.paypal.com/sdk/js?client-id=Ady-fs_MNNG5Ue22tNNapD9abvFULboMBDy5vAbpDYt8jCVNkqeyS1hssK58OTIWLWQt5xHxZlcZ_hSB&currency=USD&intent=capture"></script>

<!-- üü¢ Script 1: ÿßŸÑŸÖŸÜÿ™ÿ¨ + PayPal -->
<script>
const params = new URLSearchParams(window.location.search);
const productId = params.get('id');

fetch('https://backend-creovea.onrender.com/products')
.then(res => res.json())
.then(products => {
    const product = products.find(p => p.id === productId);
    if (!product) return alert('Product not found');

    document.getElementById('name').textContent = product.name;
    document.getElementById('seller').textContent = 'Seller: ' + product.sellerEmail;
    document.getElementById('desc').textContent = product.description;
    document.getElementById('price').textContent = '$' + product.price;
    document.getElementById('image').src = product.previewImage;

    paypal.Buttons({
        createOrder: (data, actions) => {
            return actions.order.create({
                purchase_units: [{
                    amount: { value: product.price }
                }]
            });
        },
        onApprove: async (data) => {
            const res = await fetch('https://backend-creovea.onrender.com/record-payment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    productId: product.id,
                    orderId: data.orderID
                })
            });
            const result = await res.json();
            if (result.success) {
                window.location.href = result.downloadUrl;
            } else {
                alert('Payment failed');
            }
        }
    }).render('#paypal-button-container');
});
</script>

<!-- üü£ Script 2: Firebase + Reviews -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDocs,
  query, where, collection, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCh2Pf1c1Gb7fQCQy64WmNYvWBKffwiuOs",
  authDomain: "creoveo-7da32.firebaseapp.com",
  projectId: "creoveo-7da32",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let selectedLike = null;

onAuthStateChanged(auth, user => {
  currentUser = user;
});

document.getElementById('likeBtn').onclick = () => selectedLike = true;
document.getElementById('dislikeBtn').onclick = () => selectedLike = false;

async function loadReviews() {
  const q = query(collection(db, "reviews"), where("productId", "==", productId));
  const snap = await getDocs(q);
  const list = document.getElementById('reviewsList');
  list.innerHTML = '';

  snap.forEach(d => {
    const r = d.data();
    list.innerHTML += `
      <p>${r.like ? 'üëç' : 'üëé'} <strong>${r.userEmail}</strong><br>${r.comment}</p><hr>
    `;
  });
}

document.getElementById('submitReview').onclick = async () => {
  if (!currentUser) return alert('Login required');
  if (selectedLike === null) return alert('Choose like or dislike');

  const comment = document.getElementById('reviewComment').value.trim();
  const reviewId = `${productId}_${currentUser.uid}`;

  await setDoc(doc(db, "reviews", reviewId), {
    productId,
    userId: currentUser.uid,
    userEmail: currentUser.email,
    like: selectedLike,
    comment,
    createdAt: serverTimestamp()
  });

  alert('Review submitted');
  loadReviews();
};

loadReviews();
</script>

</body>
</html>
